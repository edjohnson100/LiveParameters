<!DOCTYPE html>
<html data-theme="dark">
<head>
    <title>Live Parameters</title>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg-body: #f5f5f5;
            --text-main: #333333;
            --text-sub: #666666;
            --border-color: #dddddd;
            --row-bg: #ffffff;
            --row-border: #cccccc;
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --input-text: #333333;
            --toggle-bg: #ccc;
            --header-hover: #e8e8e8;
            
            --status-success-bg: #d4edda;
            --status-success-text: #155724;
            --status-success-border: #c3e6cb;
            
            --status-error-bg: #f8d7da;
            --status-error-text: #721c24;
            --status-error-border: #f5c6cb;

            --status-info-bg: #cce5ff;
            --status-info-text: #004085;
            --status-info-border: #b8daff;
        }

        [data-theme="dark"] {
            --bg-body: #222222;
            --text-main: #eeeeee;
            --text-sub: #cccccc;
            --border-color: #444444;
            --row-bg: #2a2a2a;
            --row-border: #444444;
            --input-bg: #333333;
            --input-border: #555555;
            --input-text: #ffffff;
            --toggle-bg: #555;
            --header-hover: #333333;

            --status-success-bg: #1e4620;
            --status-success-text: #d4edda;
            --status-success-border: #155724;

            --status-error-bg: #4c1d1d;
            --status-error-text: #f8d7da;
            --status-error-border: #721c24;

            --status-info-bg: #1d364d;
            --status-info-text: #cce5ff;
            --status-info-border: #004085;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 15px; font-size: 13px;
        }

        .header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: flex-start; }
        .title-group { flex-grow: 1; }
        h2 { margin: 0 0 2px 0; font-size: 14px; text-transform: uppercase; }
        .sub-header { color: var(--text-sub); font-size: 11px; font-style: italic; }

        /* Controls Area */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--row-border);
            gap: 10px;
        }
        
        .search-container { flex-grow: 1; }
        .search-input {
            width: 100%;
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--input-text);
            font-size: 12px;
            outline: none;
        }
        .search-input:focus { border-color: #0078d4; }

        /* Collapsible Section Styles */
        .section { margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; }
        .section-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 10px; background: var(--row-bg); cursor: pointer; user-select: none;
        }
        .section-header h3 { margin: 0; font-size: 13px; }
        .section-content { padding: 10px; background: var(--bg-body); border-top: 1px solid var(--border-color); }
        .section.collapsed .section-content { display: none; }
        .arrow { font-size: 10px; transition: transform 0.2s; }
        .section.collapsed .arrow { transform: rotate(-90deg); }

        /* Creation Form Grid */
        .create-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .full-width { grid-column: span 2; }
        
        .btn-success { 
            background-color: #28a745; color: white; border: none; 
            padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; 
        }
        .btn-success:hover { background-color: #218838; }

        input, select { 
            background: var(--input-bg); 
            border: 1px solid var(--input-border); 
            color: var(--input-text); 
            padding: 6px; 
            border-radius: 3px; 
            width: 100%; 
            box-sizing: border-box; 
        }

        /* Status Box Styling */
        .status-box { 
            margin-bottom: 15px; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 12px; 
            text-align: center; 
            display: none; 
            font-weight: bold;
        }
        .status-box.success { background: var(--status-success-bg); color: var(--status-success-text); border: 1px solid var(--status-success-border); display: block; }
        .status-box.error { background: var(--status-error-bg); color: var(--status-error-text); border: 1px solid var(--status-error-border); display: block; }
        .status-box.info { background: var(--status-info-bg); color: var(--status-info-text); border: 1px solid var(--status-info-border); display: block; }

        /* Parameter Rows */
        .param-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 8px; background: var(--row-bg); padding: 8px; 
            border-radius: 4px; border: 1px solid var(--row-border); 
        }
        .param-label { width: 55%; font-weight: bold; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
        .param-input { width: 40%; display: flex; align-items: center; }

        /* Icon Buttons */
        .icon-action-btn { 
            background: none; border: none; cursor: pointer; 
            font-size: 14px; line-height: 1; padding: 0 4px; margin-left: 2px;
            color: var(--text-sub);
        }
        .icon-action-btn:hover { color: var(--text-main); }
        .del-btn:hover { color: #d9534f; }

        .fav-toggle { 
            display: flex; align-items: center; cursor: pointer; 
            font-size: 11px; color: var(--text-sub); font-weight: bold;
            white-space: nowrap; gap: 5px; 
        }
        .fav-toggle input { margin: 0; }
        
        /* Theme Switch */
        .theme-switch { position: relative; display: inline-block; width: 34px; height: 18px; margin-left: 10px; }
        .theme-switch input { display: none; }
        .theme-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--toggle-bg); transition: .4s; border-radius: 34px; }
        .theme-slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .theme-slider { background-color: #0078d4; }
        input:checked + .theme-slider:before { transform: translateX(16px); }

        .icon-btn { background-color: #0078d4; color: white; padding: 4px 10px; font-size: 12px; border:none; border-radius:4px; cursor:pointer;}
        .empty-state { padding: 10px; color: var(--text-sub); text-align: center; font-style: italic; }

        /* --- EDIT MODAL STYLES --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: var(--row-bg);
            padding: 20px;
            border-radius: 8px;
            width: 85%;
            max-width: 300px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .modal-content h3 { margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .modal-label { font-size: 11px; color: var(--text-sub); font-weight: bold; margin-bottom: -5px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
        .modal-btn { flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: var(--input-border); color: var(--text-main); }
        .btn-save { background: #0078d4; color: white; }

    </style>
</head>
<body>
    <div class="header">
        <div class="title-group">
            <h2>Live Parameters</h2>
            <div id="docName" class="sub-header">Scanning...</div>
        </div>
        
        <label class="theme-switch" title="Toggle Light/Dark Mode">
            <input type="checkbox" id="theme-checkbox" checked>
            <span class="theme-slider"></span>
        </label>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Edit Parameter</h3>
            
            <div class="modal-label">Name</div>
            <input type="text" id="editModalName">
            
            <div class="modal-label">Comment</div>
            <input type="text" id="editModalComment">
            
            <input type="hidden" id="editModalOldName">

            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn btn-save" onclick="saveEditModal()">Save</button>
            </div>
        </div>
    </div>

    <div class="controls-bar">
        <label class="fav-toggle" title="Show Favorites Only">
            <input type="checkbox" id="favFilterCheck">
            <span>★ Favs Only</span>
        </label>
        
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Filter parameters...">
        </div>

        <button id="scanBtn" class="icon-btn" title="Rescan Model">↻ Refresh</button>
    </div>

    <div id="sec-actions" class="section collapsed">
        <div class="section-header" onclick="toggleSection('sec-actions')">
            <h3>Add Parameter</h3>
            <span class="arrow">▼</span>
        </div>
        
        <div class="section-content">
            <div class="create-grid">
                <input type="text" id="new_name" placeholder="Name (e.g. Width)" />
                <select id="new_unit" onchange="toggleCustomUnit(this)">
                    <option value="mm">Length (mm)</option>
                    <option value="in">Length (in)</option>
                    <option value="deg">Angle (deg)</option>
                    <option value="">No Units</option>
                    <option value="TEXT">Text</option>
                    <option value="OTHER">Other...</option>
                </select>
                <input type="text" id="custom_unit" class="full-width" placeholder="Type unit (e.g. cm)" style="display:none;" />
                <input type="text" id="new_expr" placeholder="Expression" class="full-width" />
                <input type="text" id="new_comm" placeholder="Comment (Optional)" class="full-width" />
            </div>
            <button id="createBtn" class="btn-success">Create Parameter</button>
        </div>
    </div>

    <div id="statusMessage" class="status-box"></div>

    <div id="paramList" class="param-container">
        <div class="empty-state">Loading parameters...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme Logic
            const toggleSwitch = document.getElementById('theme-checkbox');
            const savedTheme = localStorage.getItem('live_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            toggleSwitch.checked = (savedTheme === 'dark');
            toggleSwitch.addEventListener('change', function(e) {
                const newTheme = e.target.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('live_theme', newTheme);
            });

            // Fav Filter
            const favCheck = document.getElementById('favFilterCheck');
            const savedFavState = localStorage.getItem('live_fav_only');
            favCheck.checked = (savedFavState === 'true');
            favCheck.addEventListener('change', function(e) {
                localStorage.setItem('live_fav_only', e.target.checked);
                if (lastReceivedData) renderUI(lastReceivedData);
            });

            // Search
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                searchQuery = e.target.value.toLowerCase();
                if (lastReceivedData) renderUI(lastReceivedData);
            });
            
            // Buttons
            const scanBtn = document.getElementById('scanBtn');
            if (scanBtn) scanBtn.addEventListener('click', (e) => { e.stopPropagation(); refreshData(); });

            // CREATE PARAMETER LOGIC
            const createBtn = document.getElementById('createBtn');
            if (createBtn) {
                createBtn.addEventListener('click', function() {
                    const name = document.getElementById('new_name').value.trim();
                    const dropdownVal = document.getElementById('new_unit').value;
                    let unit = dropdownVal;
                    let expr = document.getElementById('new_expr').value.trim();
                    const comm = document.getElementById('new_comm').value.trim();

                    if (dropdownVal === 'OTHER') {
                        unit = document.getElementById('custom_unit').value.trim();
                    }
                    if (dropdownVal === 'TEXT') {
                        unit = ""; 
                        if (!expr.startsWith("'") || !expr.endsWith("'")) {
                            showStatus({message: "Text must be enclosed in single quotes. e.g. 'MyText'", type: "error"});
                            return;
                        }
                        const content = expr.substring(1, expr.length - 1);
                        const unescapedQuote = /(?<!\\)'/.test(content);
                        if (unescapedQuote) {
                            showStatus({message: "Internal quotes must be escaped with \\. e.g. 'Ed\\'s Button'", type: "error"});
                            return;
                        }
                    }

                    if(!name || !expr) {
                        showStatus({message: "Name and Expression required", type: "error"});
                        return;
                    }

                    showStatus({message: "Creating...", type: "info"}); 
                    sendToFusion('create_param', {
                        name: name, unit: unit, expression: expr, comment: comm
                    });
                });
            }

            waitForFusion();
        });

        // --- UI HELPERS ---

        function toggleSection(id) {
            document.getElementById(id).classList.toggle('collapsed');
        }

        function toggleCustomUnit(selectObj) {
            const customInput = document.getElementById('custom_unit');
            if (selectObj.value === 'OTHER') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
            }
        }

        function deleteParam(name) {
            if (confirm("Are you sure you want to permanently delete '" + name + "'?")) {
                showStatus({message: "Deleting...", type: "info"});
                sendToFusion('delete_param', { name: name });
            }
        }

        // --- EDIT MODAL LOGIC ---
        function openEditModal(name, currentComment) {
            if (currentComment === 'null' || currentComment === null) currentComment = "";
            
            document.getElementById('editModalName').value = name;
            document.getElementById('editModalComment').value = currentComment;
            document.getElementById('editModalOldName').value = name;
            
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('editModalName').focus();
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEditModal() {
            const oldName = document.getElementById('editModalOldName').value;
            const newName = document.getElementById('editModalName').value.trim();
            const newComment = document.getElementById('editModalComment').value.trim();

            if (!newName) {
                alert("Parameter name cannot be empty.");
                return;
            }

            // Close modal immediately and show saving status
            closeEditModal();
            showStatus({message: "Saving...", type: "info"});
            
            sendToFusion('update_attributes', { 
                old_name: oldName, 
                new_name: newName, 
                comment: newComment 
            });
        }

        let statusTimeout;
        function showStatus(data) {
            const box = document.getElementById('statusMessage');
            if (!box) return;

            box.innerText = data.message;
            box.className = 'status-box ' + (data.type || '');
            box.style.display = 'block';

            if (statusTimeout) clearTimeout(statusTimeout);

            if (data.type === 'success') {
                // Clear creation inputs
                const newName = document.getElementById('new_name');
                if (newName) newName.value = '';
                const newExpr = document.getElementById('new_expr');
                if (newExpr) newExpr.value = '';
                const newComm = document.getElementById('new_comm');
                if (newComm) newComm.value = '';
            }

            statusTimeout = setTimeout(() => { 
                box.style.display = 'none'; 
            }, 3000);
        }

        // --- FUSION BRIDGE ---

        let lastReceivedData = null;
        let searchQuery = "";
        let connectionAttempts = 0;
        const MAX_ATTEMPTS = 20;

        function waitForFusion() {
            if (window.adsk) {
                if (window.adsk.fusion && window.adsk.fusion.on) {
                    window.adsk.fusion.on('update_ui', function(jsonString) {
                        renderUI(JSON.parse(jsonString));
                    });
                }
                window.fusionJavaScriptHandler = {
                    handle: function(action, data) {
                        try {
                            var parsed = typeof data === 'string' ? JSON.parse(data) : data;
                            if (action === 'update_ui') renderUI(parsed);
                            else if (action === 'notification') showStatus(parsed);
                        } catch (e) { console.error(e); }
                        return "OK";
                    }
                };
                refreshData(); 
            } else {
                connectionAttempts++;
                if (connectionAttempts > MAX_ATTEMPTS) {
                    const pContainer = document.getElementById('paramList');
                    if(pContainer) pContainer.innerHTML = '<div class="empty-state" style="color:red">Fusion Connection Timeout</div>';
                    return;
                }
                setTimeout(waitForFusion, 500);
            }
        }

        function sendToFusion(action, data = {}) {
            data.action = action;
            try {
                const json = JSON.stringify(data);
                if (window.adsk && window.adsk.fusion && window.adsk.fusion.sendCommand) {
                    window.adsk.fusion.sendCommand(json);
                } else if (window.adsk && window.adsk.fusionSendData) {
                    window.adsk.fusionSendData('send', json);
                }
            } catch (e) {}
        }

        function refreshData() { sendToFusion('refresh_data'); }
        
        function renderUI(data) {
            lastReceivedData = data;
            const docNameEl = document.getElementById('docName');
            if (docNameEl) docNameEl.innerText = data.doc_name || "Unknown Design";

            const pContainer = document.getElementById('paramList');
            const favOnly = document.getElementById('favFilterCheck').checked;

            if (pContainer) {
                pContainer.innerHTML = '';
                let paramsToShow = data.parameters || [];
                
                if (favOnly) paramsToShow = paramsToShow.filter(p => p.isFavorite);

                if (searchQuery) {
                    paramsToShow = paramsToShow.filter(p => 
                        p.name.toLowerCase().includes(searchQuery)
                    );
                }

                if (paramsToShow.length === 0) {
                    let msg = 'No User Parameters found.';
                    if (data.parameters.length > 0) {
                        if (searchQuery) msg = 'No matching parameters found.';
                        else if (favOnly) msg = 'No Favorites marked. Uncheck "Favs Only".';
                    }
                    pContainer.innerHTML = `<div class="empty-state">${msg}</div>`;
                } else {
                    paramsToShow.forEach(param => {
                        const row = document.createElement('div');
                        row.className = 'param-row';
                        const starColor = param.isFavorite ? '#ff9e3b' : '#555';
                        const safeComment = param.comment ? param.comment.replace(/'/g, "\\'") : "";
                        
                        row.innerHTML = `
                            <div class="param-label" title="${param.name}\n${safeComment}">
                                <span style="color:${starColor}; margin-right:6px; cursor:pointer;" onclick="toggleFavorite('${param.name}')">★</span>
                                ${param.name}
                            </div>
                            <div class="param-input">
                                <input type="text" value="${param.expression}" 
                                    onchange="updateParam('${param.name}', this.value)" 
                                    onkeydown="if(event.key==='Enter')this.blur()">
                                
                                <button class="icon-action-btn" title="Edit Name & Comment" 
                                    onclick="openEditModal('${param.name}', '${safeComment}')">✎</button>
                                
                                <button class="icon-action-btn del-btn" title="Delete Parameter" 
                                    onclick="deleteParam('${param.name}')">×</button>
                            </div>
                        `;
                        pContainer.appendChild(row);
                    });
                }
            }
        }

        function updateParam(name, value) { sendToFusion('update_param', { name: name, value: value }); }
        function toggleFavorite(name) { sendToFusion('toggle_favorite', { name: name }); }
    </script>
</body>
</html>